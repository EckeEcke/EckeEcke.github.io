const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),scoreBoard=document.getElementById("score"),messageBox=document.getElementById("message"),iso=new Isomer(canvas),Shape=Isomer.Shape,Point=Isomer.Point,Color=Isomer.Color,Path=Isomer.Path,buttonsPressed={right:!1,left:!1,up:!1,down:!1},colorPalettes={level1:{playfieldColor:new Color(51,51,51),playfieldColorDark:new Color(31,31,31),snakeColor:new Color(153,153,153),itemColor:new Color(255,204,0),poopColor:new Color(255,59,48)},level2:{playfieldColor:new Color(50,98,115),playfieldColorDark:new Color(30,78,95),snakeColor:new Color(238,238,238),itemColor:new Color(227,151,116),poopColor:new Color(255,69,58)},level3:{playfieldColor:new Color(58,87,67),playfieldColorDark:new Color(38,67,57),snakeColor:new Color(252,236,82),itemColor:new Color(59,112,128),poopColor:new Color(255,59,48)},level4:{playfieldColor:new Color(25,11,40),playfieldColorDark:new Color(5,0,20),snakeColor:new Color(104,87,98),itemColor:new Color(229,83,129),poopColor:new Color(255,0,0)},level5:{playfieldColor:new Color(57,57,58),playfieldColorDark:new Color(37,37,38),snakeColor:new Color(133,255,199),itemColor:new Color(255,133,82),poopColor:new Color(255,0,0)},level6:{playfieldColor:new Color(41,23,17),playfieldColorDark:new Color(21,3,0),snakeColor:new Color(141,220,164),itemColor:new Color(99,50,110),poopColor:new Color(255,59,48)},level7:{playfieldColor:new Color(99,50,110),playfieldColorDark:new Color(79,30,90),snakeColor:new Color(242,243,174),itemColor:new Color(255,82,27),poopColor:new Color(255,0,0)}},levels=[{level:1,gameSpeed:200,colorPalette:colorPalettes.level1},{level:2,gameSpeed:150,colorPalette:colorPalettes.level2},{level:3,gameSpeed:110,colorPalette:colorPalettes.level3},{level:4,gameSpeed:80,colorPalette:colorPalettes.level4},{level:5,gameSpeed:65,colorPalette:colorPalettes.level5},{level:55,gameSpeed:1,colorPalette:colorPalettes.level6},{level:7,gameSpeed:45,colorPalette:colorPalettes.level7}],gameState={direction:"up",allowDirectionChange:!0,itemCollected:!1,gameSpeed:200,gameInterval:null,score:0,level:1,intervals:{game:null,demo:null},activePalette:colorPalettes.level1},snakeStartPosition=[{x:0,y:1.5,demoMoves:["right","up","right","right","down","down","down","left","left","left","up","up"],type:"snake"},{x:0,y:1,moves:["up"],demoMoves:["up","right","up","right","right","down","down","down","left","left","left","up"],type:"snake"},{x:0,y:.5,moves:["up","up"],demoMoves:["up","up","right","up","right","right","down","down","down","left","left","left"],type:"snake"}];let snake=structuredClone(snakeStartPosition),item={x:5,y:5,type:"item"},poop={x:-1,y:-1,type:"poop"};const keyDownHandler=e=>{e.preventDefault(),gameState.allowDirectionChange&&(e.key==="d"||e.key==="ArrowRight"?(buttonsPressed.right=!0,gameState.direction!=="up"&&(gameState.direction="down",gameState.allowDirectionChange=!1)):(e.key==="a"||e.key==="ArrowLeft")&&(buttonsPressed.left=!0,gameState.direction!=="down"&&(gameState.direction="up"),gameState.allowDirectionChange=!1),e.key==="s"||e.key==="ArrowDown"?(buttonsPressed.down=!0,gameState.direction!=="right"&&(gameState.direction="left",gameState.allowDirectionChange=!1)):(e.key==="w"||e.key==="ArrowUp")&&(buttonsPressed.up=!0,gameState.direction!=="left"&&(gameState.direction="right",gameState.allowDirectionChange=!1)))},keyUpHandler=e=>{e.preventDefault(),e.key==="d"||e.key==="ArrowRight"?buttonsPressed.right=!1:(e.key==="a"||e.key==="ArrowLeft")&&(buttonsPressed.left=!1),e.key==="s"||e.key==="ArrowDown"?buttonsPressed.down=!1:(e.key==="w"||e.key==="ArrowUp")&&(buttonsPressed.up=!1)},moveSnake=e=>{snake.forEach((l,o)=>{if(!e&&o===0)return;const t=e?l.demoMoves:l.moves;if(t.length===0)return;t[0]==="up"&&(l.y+=.5),t[0]==="down"&&(l.y-=.5),t[0]==="left"&&(l.x-=.5),t[0]==="right"&&(l.x+=.5);const a=t.shift();e?l.demoMoves.push(a):l.moves.push(gameState.direction)}),gameState.allowDirectionChange=!0},moveSnakeHead=()=>{const e=snake[0];gameState.direction==="up"&&(e.y+=.5),gameState.direction==="down"&&(e.y-=.5),gameState.direction==="right"&&(e.x+=.5),gameState.direction==="left"&&(e.x-=.5),itemCollision(item)},replaceItem=()=>{gameState.itemCollected=!1;let e,l;do e=generateRandomIntegerInRange(0,7),l=generateRandomIntegerInRange(0,7);while(e===item.x&&l===item.y);item.x=e,item.y=l},generateRandomIntegerInRange=(e,l)=>Math.floor(Math.random()*(l-e+1))+e,itemCollision=()=>{if(collision(item)&&!gameState.itemCollected){gameState.score+=1,scoreBoard.innerHTML=gameState.score,gameState.itemCollected=!0,poop.x=item.x,poop.y=item.y;let e=[...snake[snake.length-1].moves];if(e.unshift(""),snake.push({x:snake[snake.length-1].x,y:snake[snake.length-1].y,moves:e,type:"snake"}),setTimeout(replaceItem,1e3),gameState.score%5===0){gameState.level+=1;const l=levels.find(o=>o.level===gameState.level);if(!l)return;gameState.gameSpeed=l.gameSpeed??gameState.gameSpeed,changeColorPalette(l.colorPalette),clearInterval(gameState.gameInterval),gameState.gameInterval=setInterval(runGame,gameState.gameSpeed),document.getElementById("level").innerHTML=gameState.level}}},changeColorPalette=e=>{gameState.activePalette=e},collision=e=>{const l=snake[0];return e.x+.5>l.x&&e.x<l.x+.5&&e.y+.5>l.y&&e.y<l.y+.5},drawPlayfield=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);const e=8,l=1,o=-1,t=gameState.activePalette.playfieldColor,a=gameState.activePalette.playfieldColorDark;iso.add(Shape.Prism(new Point(0,0,o),e,e,l),t);const i=o+l;for(let r=0;r<e;r++)for(let n=0;n<e;n++)(r+n)%2!==0&&iso.add(Shape.Prism(new Point(r,n,i),1,1,.01),a)},drawElements=e=>{const l=structuredClone(snake);l.push(item),l.push(poop),l.sort(function(o,t){return t.x-o.x}),l.sort(function(o,t){return t.y-o.y}),l.forEach(o=>{if(o.type==="snake"){iso.add(Shape.Prism(new Point(0+o.x,o.y,0),.5,.5,e),gameState.activePalette.snakeColor);let t=new Path([Point(o.x,o.y,e),Point(o.x+.5,o.y,e),Point(o.x,o.y+.5,e),Point(o.x+.5,o.y+.5,e)]);t.closed=!0;const i=snake.findIndex(r=>r.x===o.x&&r.y===o.y)===0?gameState.direction:o.moves&&o.moves[0];if(i==="left"||i==="right"){const r=new Point(o.x+.25,o.y+.25,e),n=90*Math.PI/180;t=t.rotateZ(r,n)}iso.add(t,new Color(0,0,0,.5))}else o.type==="poop"&&o.x>=0?iso.add(Shape.Pyramid(new Point(poop.x,poop.y,0),.5,.5,.5),gameState.activePalette.poopColor):o.type==="item"&&!gameState.itemCollected&&(iso.add(Shape.Prism(new Point(0+o.x,o.y,0),.5,.5,.5),gameState.activePalette.itemColor),iso.add(Shape.extrude(new Path([Point(o.x+.25,o.y+.25,.5),Point(o.x+.25,o.y,.5),Point(o.x+.25,o.y+.25,.75)]),.3),new Color(50,160,60)))})},runGame=()=>{drawPlayfield(),drawElements(.5),moveSnakeHead(),moveSnake(!1),checkGameOver()},startGame=()=>{clearInterval(gameState.intervals.demo),snake=structuredClone(snakeStartPosition),gameState.gameInterval=setInterval(runGame,gameState.gameSpeed),messageBox.innerHTML=""},checkGameOver=()=>{const e=snake[0];(e.y>7.5||e.y<0||e.x>7.5||e.x<0)&&(clearInterval(gameState.gameInterval),animateGameOver()),snake.forEach((l,o)=>{o===0&&collision(poop)&&!gameState.itemCollected&&(clearInterval(gameState.gameInterval),animateGameOver()),o>0&&collision(l)&&(clearInterval(gameState.gameInterval),animateGameOver())})},animateGameOver=()=>{let e=.5;const l=setInterval(()=>{drawPlayfield(),drawElements(e),messageBox.innerHTML="<button onclick='location.reload()'>RETRY</button>",e>0?e-=.01:clearInterval(l)},1e3/60)},showDemo=()=>{moveSnake(!0),drawPlayfield(),drawElements(.5)};gameState.intervals.demo=setInterval(showDemo,500),document.addEventListener("keydown",keyDownHandler,!1),document.addEventListener("keyup",keyUpHandler,!1),window.addEventListener("keydown",e=>{[" ","ArrowLeft","ArrowUp","ArrowRight","ArrowDown"].includes(e.key)&&e.preventDefault()},!1);
