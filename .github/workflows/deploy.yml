name: Optimize eckeecke.github.io

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Tools
        run: |
          npm install -g esbuild clean-css-cli html-minifier-terser

      - name: Prepare Dist Folder
        run: mkdir -p dist
      - name: Copy Assets
        run: |
          [ -d "images" ] && cp -r images dist/ || echo "No images"
          [ -d "assets" ] && cp -r assets dist/ || echo "No assets"
          [ -d "sounds" ] && cp -r sounds dist/ || echo "No sounds"
          find . -maxdepth 1 -name "*.html" ! -name "index.html" -exec cp {} dist/ \;
          cp robots.txt dist/ 2>/dev/null || true
          cp site.webmanifest dist/ 2>/dev/null || true
          cp sitemap.xml dist/ 2>/dev/null || true
          cp *.png dist/ 2>/dev/null || true
          cp *.ico dist/ 2>/dev/null || true
          cp *.svg dist/ 2>/dev/null || true
      - name: Minify all CSS files
        run: |
          for file in css/*.css; do
            filename=$(basename "$file")
            esbuild "$file" --minify --outfile="dist/css/$filename"
          done
      - name: Minify all js files
        run: |
          mkdir -p dist/js
          for file in js/*.js; do
            filename=$(basename "$file")
            esbuild "$file" --minify --outfile="dist/js/$filename"
          done
      - name: Minify HTML files
        run: |
          for file in *.html; do
            html-minifier-terser --collapse-whitespace --remove-comments --minify-css true --minify-js true -o "dist/$file" "$file"
          done
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist